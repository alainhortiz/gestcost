<?php

namespace AppBundle\Repository;

use Doctrine\ORM\EntityRepository;
use Exception;

/**
 * LubricanteRepository
 *
 * This class was generated by the Doctrine ORM. Add your own custom
 * repository methods below.
 */
class LubricanteRepository extends EntityRepository
{
    public function modificarLubricante($data)
    {
        try
        {
            $em = $this->getEntityManager();
            $lubricante = $em->getRepository('AppBundle:Lubricante')->find($data['idLubricante']);

            if (!empty($lubricante)) {
                $lubricante->setPrecio($data['precio']);

                $em->persist($lubricante);
                $em->flush();
                $msg = $lubricante;
            } else {
                $msg = $lubricante;
            }

        }catch (Exception $e)
        {
            $msg = 'Se produjo un error al modificar el precio del lubricante';
        }

        return $msg;
    }

    public function tipoLubricantePrecio($year)
    {
        $em = $this->getEntityManager();

        $dql = 'SELECT l.id, l.nombre, p.precio
                FROM AppBundle:Lubricante l
                JOIN l.preciosLubricantes p
                WHERE p.year = :p1
                GROUP BY l.id, l.nombre';

        $query = $em->createQuery($dql);
        $query->setParameter('p1', $year);

        return $query->getResult();

    }

    // Datos para exportar a Excel
    public function datosExportLubricante()
    {
        $em = $this->getEntityManager();

        $dql = 'SELECT e.codigo, e.nombre, e.precio as Precio
                FROM AppBundle:Lubricante e';

        return $em->createQuery($dql)->getResult();

    }
}
